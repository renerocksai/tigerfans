{% extends "base.html" %}
{% block title %}Payment ‚Äî TigerFans{% endblock %}

{% block head %}
  <!-- Lightweight QR generator (no build step) -->
  <script src="/static/qrcode.min.js" defer></script>
{% endblock %}

{% block content %}
<div class="glass squircle p-6">
  <div class="flex items-center justify-between gap-4">
    <h2 class="text-2xl font-semibold">Thanks! We‚Äôre confirming your payment‚Ä¶</h2>
    <span id="paidBadge" class="hidden text-sm px-3 py-1 squircle border border-emerald-500/30 bg-emerald-500/10 text-emerald-300">
      PAID
    </span>
  </div>

  <p id="status" class="mt-2 text-slate-300">
    Order: <span class="font-mono">{{ order_id }}</span> ¬∑ <span id="statusText">PENDING</span>
  </p>

  <div id="tickets" class="mt-8 space-y-6"></div>

  <div id="instructions" class="hidden mt-8 p-4 squircle bg-slate-900 border border-white/10 text-sm text-slate-300">
    <p class="font-medium">Save your QR code.</p>
    <p class="mt-1">You‚Äôll need it at registration to get your badge. Each ticket has a unique code.</p>
  </div>

  <div id="errBox" class="hidden mt-6 p-4 squircle bg-rose-500/5 border border-rose-500/30 text-rose-200"></div>

  <div class="mt-8 flex gap-3">
    <a href="/demo/checkout" class="px-4 py-2 squircle glass hover:bg-white/10 transition">Back to tickets</a>
  </div>
</div>

<script>
  const orderId = {{ order_id|tojson }};
  const statusText = document.getElementById('statusText');
  const paidBadge = document.getElementById('paidBadge');
  const ticketsEl = document.getElementById('tickets');
  const errBox = document.getElementById('errBox');
  const instructions = document.getElementById('instructions');

  let startedAt = Date.now();
  const PENDING_SOFT_MS = 30_000;   // show gentle reassurance after 30s
  const PENDING_HARD_MS = 120_000;  // stronger notice after 2 minutes

  function setPaidUI() {
    statusText.textContent = 'PAID';
    statusText.className = 'font-semibold text-emerald-300';
    paidBadge.classList.remove('hidden');
    instructions.classList.remove('hidden');
  }

  function setFailedUI(msg) {
    statusText.textContent = 'FAILED';
    statusText.className = 'font-semibold text-rose-300';
    errBox.textContent = msg || 'Payment did not complete (reservation expired or canceled).';
    errBox.classList.remove('hidden');
  }

  function setUnfulfilledUI() {
    statusText.textContent = 'PAID_UNFULFILLED';
    statusText.className = 'font-semibold text-amber-300';
    errBox.textContent = 'Payment received but tickets are no longer available. We will reconcile or refund.';
    errBox.classList.remove('hidden');
  }

  function setCanceledUI() {
    statusText.textContent = 'CANCELED';
    statusText.className = 'font-semibold text-slate-300';
    errBox.textContent = 'Payment canceled by user.';
    errBox.classList.remove('hidden');
  }

  // --- state for pending UX ---
  let firstPendingAt = null;     // timestamp when we first saw PENDING
  let lastWarnLevel = 0;         // 0 = none, 1 = soft, 2 = hard

  function pendingSoftNotice() {
    if (lastWarnLevel >= 1) return;
    errBox.textContent = 'Processing payment‚Ä¶ this can take a moment.';
    errBox.classList.remove('hidden');
    lastWarnLevel = 1;
  }

  function pendingHardNotice() {
    if (lastWarnLevel >= 2) return;
    errBox.textContent = 'Still processing‚Ä¶ waiting for the payment callback. If this takes unusually long, try refreshing.';
    errBox.classList.remove('hidden');
    lastWarnLevel = 2;
  }

  function renderTickets(ticket_code, gotGoodie) {
    if (ticket_code === null) return;
    ticketsEl.innerHTML = '';
    if (gotGoodie) {
      const perk = document.createElement('p');
      perk.className = 'text-emerald-300';
      perk.textContent = 'üéÅ Bonus granted!';
      ticketsEl.appendChild(perk);
    }

    const card = document.createElement('div');
    card.className = 'p-4 squircle bg-slate-900 border border-white/10';

    const header = document.createElement('div');
    header.className = 'flex items-center justify-between gap-2';
    header.innerHTML = `
      <div>
        <div class="text-sm text-slate-400">Your Ticket</div>
        <div class="font-mono text-lg text-white">${ticket_code}</div>
      </div>
      <div class="text-xs text-slate-400">Show this QR at registration</div>
    `;
    card.appendChild(header);

    const qrWrap = document.createElement('div');
    qrWrap.className = 'mt-3 flex items-center gap-4 flex-wrap';
    const qrBox = document.createElement('div');
    qrBox.id = 'qr_';
    qrBox.className = 'p-2 squircle bg-white';
    qrWrap.appendChild(qrBox);

    const actions = document.createElement('div');
    actions.className = 'flex flex-col gap-2';
    const saveBtn = document.createElement('button');
    saveBtn.className = 'px-3 py-1 squircle bg-brand-500 hover:bg-brand-400 text-white text-sm transition';
    saveBtn.textContent = 'Download QR-Code';
    actions.appendChild(saveBtn);
    qrWrap.appendChild(actions);

    card.appendChild(qrWrap);
    ticketsEl.appendChild(card);

    // Generate QR (content = ticket code)
    const qr = new QRCode(qrBox, {
      text: ticket_code,
      width: 160,
      height: 160,
      correctLevel: QRCode.CorrectLevel.M
    });

    // Download as PNG
    saveBtn.onclick = () => {
      // qrcodejs renders a <canvas> (or img). Prefer canvas.
      const canvas = qrBox.querySelector('canvas');
      const dataUrl = canvas ? canvas.toDataURL('image/png') : qrBox.querySelector('img')?.src;
      if (!dataUrl) return;
      const a = document.createElement('a');
      a.href = dataUrl;
      a.download = `${ticket_code}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
  }

  async function tick() {
    try {
      const res = await fetch(`/api/orders/${orderId}`, { cache: 'no-store' });
      const j = await res.json();

      if (j.status === 'PAID') {
        setPaidUI();
        renderTickets(j.ticket_code, j.got_goodie);
        clearInterval(timer);
        return;
      }
      if (j.status === 'PAID_UNFULFILLED') {
        setUnfulfilledUI();
        clearInterval(timer);
        return;
      }
      if (j.status === 'FAILED') {
        setFailedUI();
        clearInterval(timer);
        return;
      }
      if (j.status === 'CANCELED') {
        setCanceledUI();
        clearInterval(timer);
        return;
      }

      // PENDING
      statusText.textContent = j.status;
      statusText.className = 'text-slate-300';
      if (!firstPendingAt) firstPendingAt = performance.now();
      const elapsed = performance.now() - firstPendingAt;

      if (elapsed >= PENDING_HARD_MS) {
        pendingHardNotice();
      } else if (elapsed >= PENDING_SOFT_MS) {
        pendingSoftNotice();
      }
    } catch (e) {
      // network/JSON error: show once, keep polling
      errBox.textContent = 'Temporary error loading status. Retrying‚Ä¶';
      errBox.classList.remove('hidden');
    }
  }

  const timer = setInterval(tick, 1000);
  tick();
</script>
{% endblock %}
