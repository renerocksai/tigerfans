{% extends "base.html" %}
{% block title %}Tickets — TigerFans{% endblock %}

{% block content %}
<div class="max-w-2xl glass squircle p-6">
  <h2 class="text-2xl font-semibold">Choose your ticket</h2>

  {% if status %}
    {% set s = status|lower %}
    {% if s == 'paid' %}
      <div class="mt-3 px-4 py-3 squircle border border-emerald-500/30 bg-emerald-500/10 text-emerald-300">
        <strong class="font-semibold">PAID.</strong> You’re all set! You can purchase another ticket if you like.
      </div>
    {% elif s == 'failed' %}
      <div class="mt-3 px-4 py-3 squircle border border-rose-500/30 bg-rose-500/10 text-rose-300">
        <strong class="font-semibold">Payment failed.</strong> Please check your details and try again.
      </div>
    {% elif s == 'canceled' %}
      <div class="mt-3 px-4 py-3 squircle border border-amber-500/30 bg-amber-500/10 text-amber-300">
        <strong class="font-semibold">Payment canceled.</strong> You can try again any time.
      </div>
    {% elif s == 'paid_unfulfilled' %}
      <div class="mt-3 px-4 py-3 squircle border border-amber-500/30 bg-amber-500/10 text-amber-300">
        <strong class="font-semibold">Paid but unfulfilled.</strong> Inventory ran out—our team will reconcile or refund.
      </div>
    {% endif %}
  {% endif %}

  <form id="f" class="mt-6 grid gap-4" novalidate>
    <label class="block">
      <span class="text-sm text-slate-300">Class</span>
      <select name="cls" class="mt-1 w-full squircle bg-slate-900 border border-white/10 p-2">
        <option value="A">A — Premium (€65)</option>
        <option value="B">B — Standard (€35)</option>
      </select>
    </label>

    <label class="block">
      <span class="text-sm text-slate-300">Email</span>
      <input name="customer_email" required placeholder="alice@example.com"
             class="mt-1 w-full squircle bg-slate-900 border border-white/10 p-2"/>
    </label>

    <p id="err" class="hidden text-sm text-rose-300"></p>

    <div class="flex flex-wrap items-center gap-3">
      <button type="submit" class="px-5 py-2 squircle bg-brand-500 hover:bg-brand-400 transition font-medium">
        Pay now (Mock)
      </button>
      <a href="/" class="px-5 py-2 squircle glass hover:bg-white/10 transition">Back</a>
      <span class="text-sm text-slate-400">Single-ticket purchase. Email required.</span>
    </div>
  </form>
</div>

<script>
  const f = document.getElementById('f');
  const err = document.getElementById('err');
  const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  f.onsubmit = async (e) => {
    e.preventDefault();
    err.classList.add('hidden'); err.textContent = '';

    const data = Object.fromEntries(new FormData(f).entries());
    if (!data.customer_email || !emailRx.test(data.customer_email.trim())) {
      err.textContent = 'Please enter a valid email address.';
      err.classList.remove('hidden');
      return;
    }

    const res = await fetch('/api/checkout', {
      method:'POST',
      headers:{'content-type':'application/json'},
      body: JSON.stringify({ cls: data.cls, customer_email: data.customer_email.trim() })
    });

    if (!res.ok) {
      const j = await res.json().catch(() => ({}));
      err.textContent = j.detail || `Error ${res.status}`;
      err.classList.remove('hidden');
      return;
    }

    const j = await res.json();
    if (j.redirect_url) window.location = j.redirect_url;
  };
</script>
{% endblock %}
